!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var e,r,t=(function(e,r){e.exports=function(){function e(r){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(r)}function r(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function t(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function o(e,r,o){return r&&t(e.prototype,r),o&&t(e,o),e}function n(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function i(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,o)}return t}function s(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?i(Object(t),!0).forEach((function(r){n(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,r){return(c=Object.setPrototypeOf||function(e,r){return e.__proto__=r,e})(e,r)}function u(e,r){return!r||"object"!=typeof r&&"function"!=typeof r?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):r}function f(e){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var t,o=a(e);if(r){var n=a(this).constructor;t=Reflect.construct(o,arguments,n)}else t=o.apply(this,arguments);return u(this,t)}}var l="error",p="JS_ERROR",d="RESOURCE_LOAD_ERROR",h="HTTP_ERROR",v="CUSTOM_ERROR",y="none",w="cellular",m="slow-2g",b=function(){var e=navigator.connection,r="";if(e&&e.type){var t=e.type;r=t===y?"disconnected":t===w?e.effectiveType===m?"2g":e.effectiveType:t}return r},g={projectIdentifier:"",captureJsError:!0,captureResourceError:!0,captureAjaxError:!0,captureConsoleError:!1,isAutoUpload:!0},E=function(e){!function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),r&&c(e,r)}(n,e);var t=f(n);function n(e,o){var i;return r(this,n),(i=t.call(this,e)).handleMehod=o,i}return o(n,[{key:"push",value:function(e){if(this.pool.length<this.capacity){var r={JS_ERROR:"errorMessage",RESOURCE_LOAD_ERROR:"resourceUrl",HTTP_ERROR:"httpUrlComplete",CUSTOM_ERROR:"errorMessage"}[e.logType],t=this.pool.find((function(t){return t[r]===e[r]}));t?t.concurrency++:(e.concurrency=1,this.pool.push(e))}else this.flush()}},{key:"pop",value:function(e){"function"==typeof this.handleMehod&&this.handleMehod(e)}}]),n}(function(){function e(t){if(r(this,e),"number"!=typeof t)throw new Error("[error]WebMonitorSdkCore->BufferPool: capacity is not legal!");if(t<1)throw new Error("[error]WebMonitorSdkCore->BufferPool: capacity should not less than 0!");this.pool=[],this.capacity=t}return o(e,[{key:"push",value:function(e){}},{key:"pop",value:function(e){}},{key:"flush",value:function(){var e=this;this.pool.forEach((function(r){e.pop(r)})),this.clear()}},{key:"clear",value:function(){this.pool=[]}}]),e}()),O=function(){var e={},r=navigator.userAgent,t=r.match(/(Android);?[\s\/]+([\d.]+)?/),o=r.match(/(iPad).*OS\s([\d_]+)/),n=r.match(/(iPod)(.*OS\s([\d_]+))?/),i=!o&&r.match(/(iPhone\sOS)\s([\d_]+)/),s=r.match(/Android\s[\S\s]+Build\//);if(e.ios=e.android=e.iphone=e.iPad=e.androidChrome=!1,e.isWeixin=/MicroMessenger/i.test(r),e.os="web",e.deviceName="PC",t&&(e.os="android",e.osVersion=t[2],e.android=!0,e.androidChrome=r.toLowerCase().indexOf("chrome")>=0),(o||i||n)&&(e.os="ios",e.ios=!0),i&&!n&&(e.osVersion=i[2].replace(/_/g,"."),e.iphone=!0),o&&(e.osVersion=o[2].replace(/_/g,"."),e.iPad=!0),n&&(e.osVersion=n[3]?n[3].replace(/_/g,"."):null,e.iphone=!0),e.ios&&e.osVersion&&r.indexOf("Version/")>=0&&"10"===e.osVersion.split(".")[0]&&(e.osVersion=r.toLowerCase().split("version/")[1].split(" ")[0]),e.iphone){e.deviceName="iphone";var a=window.screen.width,c=window.screen.height;320===a&&480===c?e.deviceName="iphone 4":320===a&&568===c?e.deviceName="iphone 5/SE":375===a&&667===c?e.deviceName="iphone 6/7/8":414===a&&736===c?e.deviceName="iphone 6/7/8 Plus":375===a&&812===c&&(e.deviceName="iphone X/S/Max")}else if(e.iPad)e.deviceName="iPad";else if(s){var u=s[0].split(";")[1].replace(/Build\//g,"");e.deviceName=u.replace(/(^\s*)|(\s*$)/g,"")}if(-1===r.indexOf("Mobile")){var f=navigator.userAgent.toLowerCase();if(e.browserName="Unknown",f.indexOf("msie")>0){var l=f.match(/msie [\d.]+;/gi)[0];e.browserName=l.split("/")[0],e.browserVersion=l.split("/")[1]}if(f.indexOf("firefox")>0){var p=f.match(/firefox\/[\d.]+/gi)[0];e.browserName=p.split("/")[0],e.browserVersion=p.split("/")[1]}if(f.indexOf("safari")>0&&f.indexOf("chrome")<0){var d=f.match(/safari\/[\d.]+/gi)[0];e.browserName=d.split("/")[0],e.browserVersion=d.split("/")[1]}if(f.indexOf("chrome")>0){var h=f.match(/chrome\/[\d.]+/gi)[0];e.browserName=h.split("/")[0],e.browserVersion=h.split("/")[1]}}return e.webView=(i||o||n)&&r.match(/.*AppleWebKit(?!.*Safari)/i),e}(),j=function(){var e,r,t,o,n,i,a,c,u=window.returnCitySN||{},f={happenTime:(e=function(e){return("00"+e).substr(-2)},r=new Date,t=r.getFullYear(),o=e(r.getMonth()+1),n=e(r.getDate()),i=e(r.getHours()),a=e(r.getMinutes()),c=e(r.getSeconds()),"".concat(t,"-").concat(o,"-").concat(n," ").concat(i,":").concat(a,":").concat(c)),deviceName:O.deviceName,os:O.os,osVersion:O.osVersion,browserName:O.browserName,browserVersion:O.browserVersion,netType:b(),ipAddress:u.cip,address:u.cname},l=function(){var e="",r="";if(window&&window.location){var t=window.location,o=t.href,n=t.hash,i=t.pathname;e=o,r=n||i}return{pageUrl:e,pageKey:r}}();return s(s({},f),l)},P=function(e,r,t,o){return s(s({},j()),{},{projectIdentifier:e,logType:p,errorType:r,errorMessage:t,errorStack:o,level:l})};return function(){function t(){var e;r(this,t),(e=document.createElement("script")).type="text/javascript",e.src="http://pv.sohu.com/cityjson?ie=utf-8",e.onload=function(){e.parentNode.removeChild(e),e=null},document.body.append(e)}return o(t,[{key:"init",value:function(e){if(this.config=s(s({},g),e),this.config.isEnableBuffer){var r=this.config.bufferCapacity||10;this.bufferPool=new E(r,this.config.errorHandler)}this.config.captureJsError&&(this.handleJsError(this.config),this.handlePromiseRejectError(this.config)),this.config.captureResourceError&&this.handleResourceError(this.config),this.config.captureAjaxError&&this.handleAjaxError(this.config),this.config.captureConsoleError&&this.handleConsoleError(this.config)}},{key:"handleJsError",value:function(e){var r=this;window.onerror=function(t,o,n,i,s){var a="",c="",u="";s&&s instanceof Error?(a=s.name||"",c=s.message||t||"",u=s.stack||""):(a="Others",c=t||"",u="");var f=P(e.projectIdentifier,a,c,u);e.isEnableBuffer?r.bufferPool.push(f):e.isAutoUpload&&e.errorHandler(f)}}},{key:"handlePromiseRejectError",value:function(r){var t=this;window.onunhandledrejection=function(o){var n="",i="";"object"===e(o.reason)?(n=o.reason.message,i=o.reason.stack):(n=o.reason,i="");var s=P(r.projectIdentifier,"UncaughtInPromiseError",n,i);r.isEnableBuffer?t.bufferPool.push(s):r.isAutoUpload&&r.errorHandler(s)}}},{key:"handleResourceError",value:function(e){var r=this;window.addEventListener("error",(function(t){var o=t.target||t.srcElement;if(o instanceof HTMLScriptElement||o instanceof HTMLLinkElement||o instanceof HTMLImageElement){var n=t.target.localName,i="";"link"===n?i=t.target.href:("script"===n||"img"===n)&&(i=t.target.src);var a=s(s({},j()),{},{projectIdentifier:e.projectIdentifier,logType:d,resourceUrl:i,resourceType:n,status:"0",level:l});e.isEnableBuffer?r.bufferPool.push(a):e.isAutoUpload&&e.errorHandler(a)}}),!0)}},{key:"handleAjaxError",value:function(e){var r=this;if(window.fetch){var t=window.fetch;window.fetch=function(){var o=arguments;return t.apply(this,arguments).then((function(t){if(!t.ok){var n=s(s({},j()),{},{projectIdentifier:e.projectIdentifier,logType:h,httpUrlComplete:o[0],httpUrlShort:o[0],status:t,statusText:t,level:l});e.isEnableBuffer?r.bufferPool.push(n):e.isAutoUpload&&e.errorHandler(n)}return t})).catch((function(t){var n=s(s({},j()),{},{projectIdentifier:e.projectIdentifier,logType:h,httpUrlComplete:o[0],httpUrlShort:o[0],status:t.message,statusText:t.stack,level:l});e.isEnableBuffer?r.bufferPool.push(n):e.isAutoUpload&&e.errorHandler(n)}))}}if(window.XMLHttpRequest){var o=window.XMLHttpRequest,n=o.prototype.open,i=o.prototype.send,a=function(t){if(t&&t.currentTarget&&200!==t.currentTarget.status){var o=s(s({},j()),{},{projectIdentifier:e.projectIdentifier,logType:h,httpUrlComplete:t.target.responseURL||this._url,httpUrlShort:t.target.response||this._url,status:t.target.status,statusText:t.target.statusText,level:l});e.isEnableBuffer?r.bufferPool.push(o):e.isAutoUpload&&e.errorHandler(o)}};o.prototype.open=function(e,r){this._url=r;for(var t=arguments.length,o=new Array(t>2?t-2:0),i=2;i<t;i++)o[i-2]=arguments[i];return n.apply(this,[e,r].concat(o))},o.prototype.send=function(){if(this.addEventListener)this.addEventListener("error",a),this.addEventListener("load",a),this.addEventListener("abort",a);else{var e=this.onreadystatechange;this.onreadystatechange=function(r){4===this.readyState&&a(r),e&&e.apply(this,arguments)}}return i.apply(this,arguments)}}}},{key:"handleConsoleError",value:function(e){if(window.console&&window.console.error){var r=window.console.error,t=this;window.console.error=function(o){var n=arguments[0]&&arguments[0].message||o,i=arguments[0]&&arguments[0].stack,a=s(s({},j()),{},{projectIdentifier:e.projectIdentifier,logType:v,errorType:v,errorMessage:n,errorStack:i});return e.isEnableBuffer?t.bufferPool.push(a):e.isAutoUpload&&e.errorHandler(a),r.apply(window.console,arguments)}}}},{key:"setIsAutoUpload",value:function(e){this.config.isAutoUpload=!!e}}]),t}()}()}(r={path:e,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&r.path)}},r.exports),r.exports);function o(e,r,t,o,n,i,s){try{var a=e[i](s),c=a.value}catch(e){return void t(e)}a.done?r(c):Promise.resolve(c).then(o,n)}function n(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var i=function(){function e(r){!function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this,e),this.config=r,this.setXmlHttp()}var r,t,o;return r=e,(t=[{key:"setXmlHttp",value:function(){var e=null;window.XMLHttpRequest?e=new XMLHttpRequest:window.ActiveXObject&&(e=new ActiveXObject("Microsoft.XMLHTTP")),null!==e?this.xmlHttp=e:console.error("[error]web-monitor-client: 客户端不支持xmlHttp")}},{key:"fetch",value:function(e){var r=this;return new Promise((function(t,o){var n=r.xmlHttp,i=r.config.baseUrl,s=void 0===i?"":i,a=e.method,c=void 0===a?"GET":a,u=e.url,f=e.params,l=void 0===f?{}:f,p=e.async,d=void 0===p||p;if("GET"==(c=c.toUpperCase())){var h=u;for(var v in h+="?",l)h+=v+"="+l[v]+"&";h=h.substring(0,h.length-1),n.open("GET",s+h,d),n.send(null)}"POST"==c&&(n.open("POST",s+u,d),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(l)),n.onreadystatechange=function(){if(4===n.readyState){var e=JSON.parse(n.responseText);200===n.status&&e?t(e):o(e)}}}))}}])&&n(r.prototype,t),o&&n(r,o),e}(),s=new i({baseUrl:"http://localhost:6001"}),a=function(){var e=function(e){return function(){var r=this,t=arguments;return new Promise((function(n,i){var s=e.apply(r,t);function a(e){o(s,n,i,a,c,"next",e)}function c(e){o(s,n,i,a,c,"throw",e)}a(void 0)}))}}(regeneratorRuntime.mark((function e(r,t){var o,n,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,s.fetch({method:"GET",url:"/project/getByProjectIdentifier",params:{projectIdentifier:r}});case 3:o=e.sent,n=o.success,i=o.data,n?"function"==typeof t&&t(i):console.error("[error]web-monitor-sdk: getByProjectIdentifier",o),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),console.error("[error]web-monitor-sdk: getByProjectIdentifier",e.t0);case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(r,t){return e.apply(this,arguments)}}();!function(e){var r=document.getElementById("web-monitor-sdk");if(!r)return console.error("[error]web-monitor-sdk: 无法找到script标签！");var t=r.getAttribute("src").split("?");if(t.length<2)return console.error("[error]web-monitor-sdk: script标签缺少参数！");var o=t[1].split("&").map((function(e){var r,t,o,n=e.split("=");if(n.length>1)return r={},t=n[0],o=n[1],t in r?Object.defineProperty(r,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):r[t]=o,r})).find((function(e){return e.key}));if(!o)return console.error("[error]web-monitor-sdk: script标签参数错误！");e&&"function"==typeof e&&e(o.key)}((function(e){a(e,(function(e){var r=e.projectIdentifier,o=e.activeFuncs,n=e.isAutoUpload,i=o.length?o.split(","):[],s=function(e){return i.indexOf(e)>-1},a=new t,c={projectIdentifier:r,captureJsError:s("jsError"),captureResourceError:s("ResourceLoadError"),captureAjaxError:s("httpError"),captureConsoleError:s("customError"),isAutoUpload:n,isEnableBuffer:!1,bufferCapacity:10,errorHandler:function(e){console.log("[log]web-monitor-sdk",e)}};a.init(c),console.log("[log]web-monitor-sdk","开启成功")}))}))}));
